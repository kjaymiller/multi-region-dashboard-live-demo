<!-- Performance Metrics Charts -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-bar-chart-line-fill me-2" viewBox="0 0 16 16">
                        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1z"/>
                    </svg>
                    Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Time Range:</label>
                        <select id="timeRangeSelector" class="form-select" onchange="refreshCharts()">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshCharts()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                            </svg>
                            Refresh Charts
                        </button>
                    </div>
                </div>

                <!-- Latency Chart -->
                <div class="mb-4">
                    <h6>Database Latency Over Time</h6>
                    <canvas id="latencyChart" height="80"></canvas>
                </div>

                <!-- Cache Hit Ratio Chart -->
                <div class="mb-4">
                    <h6>Cache Hit Ratio Over Time</h6>
                    <canvas id="cacheHitChart" height="80"></canvas>
                </div>

                <!-- Active Connections Chart -->
                <div class="mb-4">
                    <h6>Active Connections Over Time</h6>
                    <canvas id="connectionsChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Summary Charts -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">Average Latency (24h)</h6>
            </div>
            <div class="card-body">
                <canvas id="latencySummaryChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">Success Rate (24h)</h6>
            </div>
            <div class="card-body">
                <canvas id="successRateChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">Cache Hit Ratio (24h)</h6>
            </div>
            <div class="card-body">
                <canvas id="cacheHitSummaryChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// Chart instances
let latencyChart, cacheHitChart, connectionsChart;
let latencySummaryChart, successRateChart, cacheHitSummaryChart;

// Color palette for different databases
const colorPalette = [
    'rgb(255, 99, 132)',
    'rgb(54, 162, 235)',
    'rgb(255, 205, 86)',
    'rgb(75, 192, 192)',
    'rgb(153, 102, 255)',
    'rgb(255, 159, 64)',
    'rgb(199, 199, 199)',
    'rgb(83, 102, 255)',
    'rgb(255, 99, 255)',
    'rgb(99, 255, 132)'
];

// Initialize all charts
async function initCharts() {
    const timeRange = document.getElementById('timeRangeSelector').value;

    try {
        // Fetch time series data
        const [latencyResponse, healthResponse, summaryResponse] = await Promise.all([
            fetch(`/api/charts/latency?hours=${timeRange}`),
            fetch(`/api/charts/health-metrics?hours=${timeRange}`),
            fetch('/api/charts/performance-summary')
        ]);

        const latencyData = await latencyResponse.json();
        const healthData = await healthResponse.json();
        const summaryData = await summaryResponse.json();

        // Initialize time series charts
        initLatencyChart(latencyData);
        initCacheHitChart(healthData);
        initConnectionsChart(healthData);

        // Initialize summary charts
        initLatencySummaryChart(summaryData.latency);
        initSuccessRateChart(summaryData.success_rate);
        initCacheHitSummaryChart(summaryData.cache_hit);
    } catch (error) {
        console.error('Error loading chart data:', error);
    }
}

function initLatencyChart(data) {
    const ctx = document.getElementById('latencyChart').getContext('2d');

    if (latencyChart) {
        latencyChart.destroy();
    }

    const datasets = data.datasets.map((dataset, index) => ({
        label: dataset.label,
        data: dataset.timestamps.map((timestamp, i) => ({
            x: timestamp,
            y: dataset.data[i]
        })),
        borderColor: colorPalette[index % colorPalette.length],
        backgroundColor: colorPalette[index % colorPalette.length] + '33',
        tension: 0.4,
        fill: false
    }));

    latencyChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Latency (ms)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

function initCacheHitChart(data) {
    const ctx = document.getElementById('cacheHitChart').getContext('2d');

    if (cacheHitChart) {
        cacheHitChart.destroy();
    }

    const datasets = data.cache_hit_datasets.map((dataset, index) => ({
        label: dataset.label,
        data: dataset.timestamps.map((timestamp, i) => ({
            x: timestamp,
            y: dataset.data[i]
        })),
        borderColor: colorPalette[index % colorPalette.length],
        backgroundColor: colorPalette[index % colorPalette.length] + '33',
        tension: 0.4,
        fill: false
    }));

    cacheHitChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Cache Hit Ratio (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    });
}

function initConnectionsChart(data) {
    const ctx = document.getElementById('connectionsChart').getContext('2d');

    if (connectionsChart) {
        connectionsChart.destroy();
    }

    const datasets = data.connections_datasets.map((dataset, index) => ({
        label: dataset.label,
        data: dataset.timestamps.map((timestamp, i) => ({
            x: timestamp,
            y: dataset.data[i]
        })),
        borderColor: colorPalette[index % colorPalette.length],
        backgroundColor: colorPalette[index % colorPalette.length] + '33',
        tension: 0.4,
        fill: false
    }));

    connectionsChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    title: {
                        display: true,
                        text: 'Active Connections'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

function initLatencySummaryChart(data) {
    const ctx = document.getElementById('latencySummaryChart').getContext('2d');

    if (latencySummaryChart) {
        latencySummaryChart.destroy();
    }

    latencySummaryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Avg Latency (ms)',
                data: data.values,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Latency (ms)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(2) + ' ms';
                        }
                    }
                }
            }
        }
    });
}

function initSuccessRateChart(data) {
    const ctx = document.getElementById('successRateChart').getContext('2d');

    if (successRateChart) {
        successRateChart.destroy();
    }

    successRateChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Success Rate (%)',
                data: data.values,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Success Rate (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    });
}

function initCacheHitSummaryChart(data) {
    const ctx = document.getElementById('cacheHitSummaryChart').getContext('2d');

    if (cacheHitSummaryChart) {
        cacheHitSummaryChart.destroy();
    }

    cacheHitSummaryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Cache Hit Ratio (%)',
                data: data.values,
                backgroundColor: 'rgba(153, 102, 255, 0.7)',
                borderColor: 'rgb(153, 102, 255)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Cache Hit Ratio (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    });
}

function refreshCharts() {
    initCharts();
}

// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initCharts();

    // Auto-refresh charts every 5 minutes
    setInterval(refreshCharts, 300000);
});
</script>
