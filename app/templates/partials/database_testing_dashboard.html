<!-- Database Testing Dashboard -->
<div class="row mb-4" x-data="databaseTestingDashboard()">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Database Testing & Health Checks</h5>
                    <small class="text-muted">Monitor and test all database connections</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" @click="testAllDatabases()">
                        <span class="spinner-border spinner-border-sm me-1" x-show="loading.all"></span>
                        Test All
                    </button>
                    <button class="btn btn-sm btn-success" @click="healthCheckAll()">
                        <span class="spinner-border spinner-border-sm me-1" x-show="loading.health"></span>
                        Health Check
                    </button>
                    <button class="btn btn-sm btn-info" @click="refreshSummary()">
                        <span class="spinner-border spinner-border-sm me-1" x-show="loading.summary"></span>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Summary Cards -->
                <div class="row mb-4" x-show="summary">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">Total Databases</h5>
                                <h3 class="card-text" x-text="summary.total_databases || 0"></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Healthy</h5>
                                <h3 class="card-text" x-text="summary.healthy_databases || 0"></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h5 class="card-title">Slow</h5>
                                <h3 class="card-text" x-text="summary.slow_databases || 0"></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">Unhealthy</h5>
                                <h3 class="card-text" x-text="summary.unhealthy_databases || 0"></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database List -->
                <div class="table-responsive" x-show="databases.length > 0">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Database</th>
                                <th>Provider</th>
                                <th>Region</th>
                                <th>Connection</th>
                                <th>Latency</th>
                                <th>Health</th>
                                <th>Load Test</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="db in databases" :key="db.id">
                                <tr>
                                    <td>
                                        <div>
                                            <strong x-text="db.name"></strong>
                                            <br>
                                            <small class="text-muted" x-text="`${db.host}:${db.port}`"></small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge"
                                              :class="getProviderBadgeClass(db.cloud_provider)"
                                              x-text="db.cloud_provider"></span>
                                    </td>
                                    <td>
                                        <span class="text-muted" x-text="db.region"></span>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                              :class="db.connection_test?.success ? 'bg-success' : 'bg-danger'"
                                              x-text="db.connection_test?.success ? 'Connected' : 'Failed'"></span>
                                        <br>
                                        <small class="text-muted" 
                                               x-show="db.connection_test?.latency_ms"
                                               x-text="`${db.connection_test.latency_ms}ms`"></small>
                                    </td>
                                    <td>
                                        <div x-show="db.latency_test?.success">
                                            <span class="badge"
                                                  :class="getLatencyBadgeClass(db.latency_test.avg_ms)">
                                                <span x-text="`${Math.round(db.latency_test.avg_ms)}ms`"></span>
                                            </span>
                                            <br>
                                            <small class="text-muted">
                                                Min: <span x-text="Math.round(db.latency_test.min_ms)"></span>ms /
                                                Max: <span x-text="Math.round(db.latency_test.max_ms)"></span>ms
                                            </small>
                                        </div>
                                        <div x-show="db.latency_test && !db.latency_test.success">
                                            <span class="badge bg-danger">Failed</span>
                                            <br>
                                            <small class="text-muted" x-text="db.latency_test.error"></small>
                                        </div>
                                        <div x-show="!db.latency_test">
                                            <span class="badge bg-secondary">Not tested</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div x-show="db.health_metrics?.success">
                                            <div class="small">
                                                <div>Cache: <span x-text="db.health_metrics.cache_hit_ratio || 'N/A'"></span>%</div>
                                                <div>Connections: <span x-text="db.health_metrics.active_connections || 'N/A'"></span></div>
                                                <div x-show="db.health_metrics.pg_stat_statements_available">
                                                    <span class="badge bg-success">pg_stat_statements</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-xs btn-outline-info mt-1"
                                                    @click="showHealthDetails(db)"
                                                    x-show="db.health_metrics.pg_stat_statements && db.health_metrics.pg_stat_statements.length > 0">
                                                View Queries
                                            </button>
                                        </div>
                                        <div x-show="!db.health_metrics?.success">
                                            <span class="badge bg-secondary">Not checked</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div x-show="db.load_test?.success">
                                            <span class="badge"
                                                  :class="getLatencyBadgeClass(db.load_test.avg_ms)">
                                                <span x-text="`${Math.round(db.load_test.avg_ms)}ms`"></span>
                                            </span>
                                            <br>
                                            <small class="text-muted">
                                                QPS: <span x-text="Math.round(db.load_test.queries_per_second)"></span> /
                                                Concurrent: <span x-text="db.load_test.concurrent"></span>
                                            </small>
                                        </div>
                                        <div x-show="db.load_test && !db.load_test.success">
                                            <span class="badge bg-danger">Failed</span>
                                            <br>
                                            <small class="text-muted" x-text="db.load_test.error"></small>
                                        </div>
                                        <div x-show="!db.load_test">
                                            <span class="badge bg-secondary">Not tested</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    @click="testDatabase(db.id)">
                                                Test
                                            </button>
                                            <button class="btn btn-outline-success" 
                                                    @click="healthCheck(db.id)">
                                                Health
                                            </button>
                                            <button class="btn btn-outline-info" 
                                                    @click="latencyTest(db.id)">
                                                Latency
                                            </button>
                                            <button class="btn btn-outline-warning" 
                                                    @click="loadTest(db.id)">
                                                Load
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div class="text-center py-4" x-show="!databases.length && !loading.all">
                    <p class="text-muted">No database connections found. Configure some databases to get started.</p>
                </div>

                <!-- Error Messages -->
                <div class="alert alert-danger" x-show="error" x-text="error"></div>
            </div>
        </div>
    </div>

    <!-- Health Details Modal -->
    <div class="modal fade" id="healthDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span x-text="selectedDb?.name"></span> - Health Metrics
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Health details will be loaded via AJAX -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function databaseTestingDashboard() {
    return {
        databases: [],
        summary: null,
        selectedDb: null,
        loading: {
            all: false,
            health: false,
            summary: false
        },
        error: null,

        init() {
            this.refreshSummary();

            // Listen for connection-created events to refresh the dashboard
            document.body.addEventListener('connection-created', () => {
                this.refreshSummary();
            });

            document.body.addEventListener('connection-test-failed', () => {
                this.refreshSummary();
            });
        },

        async refreshSummary() {
            this.loading.summary = true;
            this.error = null;
            
            try {
                const [summaryResponse, healthResponse] = await Promise.all([
                    fetch('/api/database-summary'),
                    fetch('/api/health-all-databases')
                ]);
                
                const summary = await summaryResponse.json();
                const health = await healthResponse.json();
                
                this.summary = {
                    ...summary,
                    ...health,
                    healthy_databases: health.healthy_databases,
                    unhealthy_databases: health.unhealthy_databases,
                    slow_databases: 0 // Calculate from actual data
                };
                
                this.databases = health.results || [];
                
            } catch (error) {
                this.error = `Failed to load database summary: ${error.message}`;
                console.error('Error loading summary:', error);
            } finally {
                this.loading.summary = false;
            }
        },

        async testAllDatabases() {
            this.loading.all = true;
            
            try {
                const response = await fetch('/api/test-all-databases');
                const result = await response.json();
                
                if (response.ok) {
                    // Update database results
                    result.results.forEach(testResult => {
                        const db = this.databases.find(d => d.id === testResult.id);
                        if (db) {
                            db.connection_test = testResult.test_result;
                        }
                    });
                } else {
                    this.error = result.error || 'Failed to test databases';
                }
            } catch (error) {
                this.error = `Failed to test databases: ${error.message}`;
            } finally {
                this.loading.all = false;
            }
        },

        async healthCheckAll() {
            this.loading.health = true;
            
            try {
                const response = await fetch('/api/health-all-databases');
                const result = await response.json();
                
                if (response.ok) {
                    this.databases = result.results || [];
                } else {
                    this.error = result.error || 'Failed to get health checks';
                }
            } catch (error) {
                this.error = `Failed to get health checks: ${error.message}`;
            } finally {
                this.loading.health = false;
            }
        },

        async testDatabase(dbId) {
            try {
                const response = await fetch(`/api/test-database/${dbId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const db = this.databases.find(d => d.id === dbId);
                    if (db) {
                        db.connection_test = result;
                    }
                    if (result.coords) {
                        window.dispatchEvent(new CustomEvent('database-tested', { detail: { coords: result.coords } }));
                    }
                } else {
                    this.error = result.error || 'Failed to test database';
                }
            } catch (error) {
                this.error = `Failed to test database: ${error.message}`;
            }
        },

        async healthCheck(dbId) {
            try {
                const response = await fetch(`/api/health-check/${dbId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const db = this.databases.find(d => d.id === dbId);
                    if (db) {
                        db.health_metrics = result;
                    }
                    if (result.coords) {
                        window.dispatchEvent(new CustomEvent('database-tested', { detail: { coords: result.coords } }));
                    }
                } else {
                    this.error = result.error || 'Failed to get health metrics';
                }
            } catch (error) {
                this.error = `Failed to get health metrics: ${error.message}`;
            }
        },

        async latencyTest(dbId) {
            const iterations = prompt('How many iterations? (1-100)', '5');
            if (!iterations) return; // User cancelled

            const iterationsNum = parseInt(iterations);
            if (isNaN(iterationsNum) || iterationsNum < 1 || iterationsNum > 100) {
                this.error = 'Iterations must be between 1 and 100';
                return;
            }

            try {
                const response = await fetch(`/api/latency-test/${dbId}?iterations=${iterationsNum}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (response.ok) {
                    const db = this.databases.find(d => d.id === dbId);
                    if (db) {
                        db.latency_test = result;
                    }
                    if (result.coords) {
                        window.dispatchEvent(new CustomEvent('database-tested', { detail: { coords: result.coords } }));
                    }
                } else {
                    this.error = result.error || 'Failed to test latency';
                }
            } catch (error) {
                this.error = `Failed to test latency: ${error.message}`;
            }
        },

        async loadTest(dbId) {
            const concurrent = prompt('How many concurrent connections? (1-100)', '10');
            if (!concurrent) return; // User cancelled

            const concurrentNum = parseInt(concurrent);
            if (isNaN(concurrentNum) || concurrentNum < 1 || concurrentNum > 100) {
                this.error = 'Concurrent connections must be between 1 and 100';
                return;
            }

            try {
                const response = await fetch(`/api/load-test/${dbId}?concurrent=${concurrentNum}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (response.ok) {
                    const db = this.databases.find(d => d.id === dbId);
                    if (db) {
                        db.load_test = result;
                    }
                    if (result.coords) {
                        window.dispatchEvent(new CustomEvent('database-tested', { detail: { coords: result.coords } }));
                    }
                } else {
                    this.error = result.error || 'Failed to run load test';
                }
            } catch (error) {
                this.error = `Failed to run load test: ${error.message}`;
            }
        },

        getProviderBadgeClass(provider) {
            const classes = {
                'AWS': 'bg-warning text-dark',
                'GCP': 'bg-info text-white',
                'Azure': 'bg-primary text-white',
                'Aiven': 'bg-danger text-white',
                'DigitalOcean': 'bg-success text-white'
            };
            return classes[provider] || 'bg-secondary text-white';
        },

        getLatencyBadgeClass(latency) {
            if (!latency) return 'bg-secondary';
            if (latency < 100) return 'bg-success';
            if (latency < 200) return 'bg-warning text-dark';
            return 'bg-danger';
        },

        async showHealthDetails(db) {
            this.selectedDb = db;
            
            // Load health details via AJAX
            try {
                const response = await fetch(`/partials/health_result?connection_id=${db.id}`);
                const html = await response.text();
                
                // Update modal content
                const modalBody = document.querySelector('#healthDetailsModal .modal-body');
                if (modalBody) {
                    modalBody.innerHTML = html;
                    
                    // Execute scripts in loaded content
                    const scripts = modalBody.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                        document.head.removeChild(newScript);
                    });
                }
                
                const modal = new bootstrap.Modal(document.getElementById('healthDetailsModal'));
                modal.show();
            } catch (error) {
                console.error('Failed to load health details:', error);
                const modalBody = document.querySelector('#healthDetailsModal .modal-body');
                if (modalBody) {
                    modalBody.innerHTML = '<div class="alert alert-danger">Failed to load health details</div>';
                }
            }
        },

        renderHealthMetrics(metrics) {
            if (!metrics) return '';

            let html = '<div class="health-result">';

            // Summary metrics
            html += '<div class="row g-2 mb-3">';
            html += `<div class="col-4"><div class="metric-card">`;
            html += `<div class="metric-value ${metrics.cache_hit_ratio > 95 ? 'text-success' : metrics.cache_hit_ratio > 80 ? 'text-warning' : 'text-danger'}">${metrics.cache_hit_ratio || 'N/A'}%</div>`;
            html += `<div class="metric-label">Cache Hit Ratio</div></div></div>`;

            html += `<div class="col-4"><div class="metric-card">`;
            html += `<div class="metric-value">${metrics.db_size || 'N/A'}</div>`;
            html += `<div class="metric-label">Database Size</div></div></div>`;

            html += `<div class="col-4"><div class="metric-card">`;
            html += `<div class="metric-value text-success">${metrics.active_connections || 'N/A'} / ${metrics.total_connections || 'N/A'}</div>`;
            html += `<div class="metric-label">Active / Total Connections</div></div></div>`;
            html += '</div>';

            // Query statistics
            if (metrics.pg_stat_statements_available && metrics.pg_stat_statements && metrics.pg_stat_statements.length > 0) {
                html += '<div class="mt-4"><h6>Most Expensive Queries</h6>';
                html += '<div class="table-responsive"><table class="table table-sm table-hover">';
                html += '<thead><tr>';
                html += '<th>Query</th><th>Calls</th><th>Mean (ms)</th><th>Max (ms)</th><th>Total (ms)</th><th>Cache %</th>';
                html += '</tr></thead><tbody>';

                metrics.pg_stat_statements.forEach(query => {
                    html += '<tr>';
                    html += `<td><code style="font-size: 0.8rem;">${this.escapeHtml(query.query)}</code></td>`;
                    html += `<td><span class="badge bg-info">${query.calls}</span></td>`;

                    const meanClass = query.mean_time_ms < 10 ? 'text-success' : query.mean_time_ms < 50 ? 'text-warning' : 'text-danger';
                    html += `<td><span class="${meanClass}">${query.mean_time_ms}</span></td>`;

                    const maxClass = query.max_time_ms < 50 ? 'text-success' : query.max_time_ms < 200 ? 'text-warning' : 'text-danger';
                    html += `<td><span class="${maxClass}">${query.max_time_ms}</span></td>`;
                    html += `<td><span class="text-muted">${query.total_time_ms}</span></td>`;

                    if (query.cache_hit_pct !== null) {
                        const cacheClass = query.cache_hit_pct > 95 ? 'text-success' : query.cache_hit_pct > 80 ? 'text-warning' : 'text-danger';
                        html += `<td><span class="${cacheClass}">${query.cache_hit_pct}%</span></td>`;
                    } else {
                        html += '<td><span class="text-muted">N/A</span></td>';
                    }
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
            }

            // Warnings
            if (metrics.warnings && metrics.warnings.length > 0) {
                html += '<div class="alert alert-warning mt-3"><strong>Warnings:</strong><ul class="mb-0">';
                metrics.warnings.forEach(warning => {
                    html += `<li>${this.escapeHtml(warning)}</li>`;
                });
                html += '</ul></div>';
            }

            html += '</div>';
            return html;
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    };
}
</script>