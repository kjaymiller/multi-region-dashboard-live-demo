<!-- Multi-Region Map Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Geographic Database Map</h5>
                    <small class="text-muted">Real-time visualization of database performance across regions</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary"
                            id="refresh-map-btn"
                            onclick="refreshMap()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                        </svg>
                        Refresh Map
                    </button>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="map-view" id="map-view-all" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="map-view-all">All</label>
                        
                        <input type="radio" class="btn-check" name="map-view" id="map-view-aws" autocomplete="off">
                        <label class="btn btn-outline-primary" for="map-view-aws">AWS</label>
                        
                        <input type="radio" class="btn-check" name="map-view" id="map-view-gcp" autocomplete="off">
                        <label class="btn btn-outline-primary" for="map-view-gcp">GCP</label>
                        
                        <input type="radio" class="btn-check" name="map-view" id="map-view-azure" autocomplete="off">
                        <label class="btn btn-outline-primary" for="map-view-azure">Azure</label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="map" style="height: 450px;"></div>
                
                <!-- Map Legend -->
                <div class="card-footer bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-2">Cloud Providers</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <div class="d-flex align-items-center">
                                    <span class="cloud-legend" style="background: #ff9900;"></span>
                                    <span>AWS</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="cloud-legend" style="background: #4285f4;"></span>
                                    <span>GCP</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="cloud-legend" style="background: #0078d4;"></span>
                                    <span>Azure</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="cloud-legend" style="background: #ff3554;"></span>
                                    <span>Aiven</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="cloud-legend" style="background: #0069ff;"></span>
                                    <span>DigitalOcean</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">Map Indicators</h6>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator status-success"></div>
                                    <span>Healthy (&lt;100ms)</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator" style="background: #ffc107;"></div>
                                    <span>Slow (100-200ms)</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator status-error"></div>
                                    <span>Unhealthy (&gt;200ms)</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div style="background: #007bff; border: 2px solid white; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span>Your Location</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div style="width: 30px; height: 2px; background: linear-gradient(to right, #28a745, #ffc107, #dc3545); opacity: 0.4;"></div>
                                    <span class="ms-1">User Connections</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let markers = [];
let connectionLines = [];
let userConnectionLines = [];
let currentFilter = 'all';
let userLocationCoords = null;

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    loadMapData();
    
    // Setup filter listeners
    document.querySelectorAll('input[name="map-view"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentFilter = this.id.replace('map-view-', '');
            filterMapMarkers();
        });
    });
});

function initializeMap() {
    // Initialize Leaflet map centered on world view
    map = L.map('map').setView([30, 0], 2);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
}

async function loadMapData() {
    try {
        // Fetch map data
        const mapResponse = await fetch('/api/map-data');
        const data = await mapResponse.json();

        // Clear existing markers and lines
        clearMap();

        // Try to get user location from browser first
        await getUserLocation();

        // Add database markers
        data.databases.forEach(db => {
            addDatabaseMarker(db);
        });

        // Draw lines from user to each database
        if (userLocationCoords) {
            data.databases.forEach(db => {
                addUserToDatabaseLine(db);
            });
        }

        // Add connection lines between databases
        data.connections.forEach(conn => {
            addConnectionLine(conn);
        });

    } catch (error) {
        console.error('Error loading map data:', error);
    }
}

async function getUserLocation() {
    if (!navigator.geolocation) {
        // Fallback to IP-based location if geolocation not supported
        await getIPLocation();
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            // Browser geolocation succeeded
            const userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                city: "Your Location",
                country: "Detected",
                ip: "Browser",
                is_local: false,
                accuracy: position.coords.accuracy
            };
            addUserLocationMarker(userLocation);
        },
        async (error) => {
            // Browser geolocation failed, fallback to IP-based
            console.log('Browser geolocation failed, using IP-based location:', error.message);
            await getIPLocation();
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes cache
        }
    );
}

async function getIPLocation() {
    try {
        const response = await fetch('/api/location');
        const userLocation = await response.json();
        if (userLocation.lat && userLocation.lon) {
            addUserLocationMarker(userLocation);
        }
    } catch (error) {
        console.error('Error getting IP location:', error);
    }
}

function addDatabaseMarker(db) {
    const statusColor = db.status === 'healthy' ? '#28a745' : 
                      db.status === 'slow' ? '#ffc107' : '#dc3545';
    
    const popupContent = `
        <div class="map-popup">
            <h6>${db.name}</h6>
            <p class="mb-1"><strong>Region:</strong> ${db.region || 'Unknown'}</p>
            <p class="mb-1"><strong>Provider:</strong> ${db.cloud_provider}</p>
            <p class="mb-1"><strong>Host:</strong> ${db.host}:${db.port}</p>
            <p class="mb-1"><strong>Database:</strong> ${db.database}</p>
            <p class="mb-1">
                <strong>Latency:</strong> 
                ${db.latency_ms ? `<span class="latency-${getLatencyClass(db.latency_ms)}">${db.latency_ms}ms</span>` : 'Unknown'}
            </p>
            ${db.cache_hit_ratio ? `<p class="mb-1"><strong>Cache Hit:</strong> ${db.cache_hit_ratio}%</p>` : ''}
            ${db.connections ? `<p class="mb-1"><strong>Connections:</strong> ${db.connections}</p>` : ''}
        </div>
    `;
    
    const marker = L.circleMarker([db.lat, db.lng], {
        radius: 8,
        fillColor: db.color,
        color: statusColor,
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    }).bindPopup(popupContent);
    
    marker.dbData = db; // Store database data for filtering
    marker.addTo(map);
    markers.push(marker);
}

function addUserLocationMarker(userLocation) {
    // Store user location coordinates for drawing lines
    userLocationCoords = { lat: userLocation.lat, lon: userLocation.lon };

    const accuracyText = userLocation.accuracy ?
        `<p class="mb-1"><strong>Accuracy:</strong> ±${Math.round(userLocation.accuracy)}m</p>` : '';

    const locationType = userLocation.ip === 'Browser' ?
        '<p class="mb-1 text-success"><em>Precise GPS location</em></p>' :
        userLocation.is_local ? '<p class="mb-1 text-muted"><em>Default location (local development)</em></p>' :
        '<p class="mb-1 text-info"><em>IP-based location</em></p>';

    const popupContent = `
        <div class="map-popup">
            <h6><strong>Your Location</strong></h6>
            <p class="mb-1"><strong>City:</strong> ${userLocation.city || 'Unknown'}</p>
            <p class="mb-1"><strong>Country:</strong> ${userLocation.country || 'Unknown'}</p>
            <p class="mb-1"><strong>Source:</strong> ${userLocation.ip || 'Unknown'}</p>
            ${accuracyText}
            ${locationType}
        </div>
    `;

    // Create a distinctive marker for user location with animation
    const userIcon = L.divIcon({
        html: '<div style="background: #007bff; border: 3px solid white; border-radius: 50%; width: 16px; height: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
        iconSize: [16, 16],
        className: 'user-location-marker'
    });

    const marker = L.marker([userLocation.lat, userLocation.lon], {
        icon: userIcon
    }).bindPopup(popupContent);

    marker.addTo(map);
    markers.push(marker);

    // Add a circle to show accuracy if available
    if (userLocation.accuracy) {
        const accuracyCircle = L.circle([userLocation.lat, userLocation.lon], {
            radius: userLocation.accuracy,
            fillColor: '#007bff',
            fillOpacity: 0.1,
            color: '#007bff',
            weight: 1
        }).addTo(map);
        markers.push(accuracyCircle);
    }
}

function addUserToDatabaseLine(db) {
    if (!userLocationCoords) return;

    const coordinates = [[userLocationCoords.lat, userLocationCoords.lon], [db.lat, db.lng]];

    // Calculate approximate distance and latency
    const distance = calculateDistance(
        userLocationCoords.lat, userLocationCoords.lon,
        db.lat, db.lng
    );
    const estimatedLatency = Math.round(distance / 200); // Rough estimate: ~200km per ms

    // Color based on latency
    let lineColor = '#28a745'; // green for close
    if (estimatedLatency > 100) lineColor = '#ffc107'; // yellow for medium
    if (estimatedLatency > 200) lineColor = '#dc3545'; // red for far

    const line = L.polyline(coordinates, {
        color: lineColor,
        weight: 2,
        opacity: 0.4,
        dashArray: '5, 5'
    });

    const popupContent = `
        <div class="map-popup">
            <p class="mb-1"><strong>Connection:</strong> You → ${db.name}</p>
            <p class="mb-1"><strong>Distance:</strong> ~${Math.round(distance)} km</p>
            <p class="mb-1"><strong>Estimated Latency:</strong> ~${estimatedLatency}ms</p>
            ${db.latency_ms ? `<p class="mb-1"><strong>Actual Latency:</strong> ${db.latency_ms}ms</p>` : ''}
        </div>
    `;

    line.bindPopup(popupContent);
    line.addTo(map);
    userConnectionLines.push(line);
}

function addConnectionLine(conn) {
    const coordinates = [[conn.from.lat, conn.from.lng], [conn.to.lat, conn.to.lng]];

    const line = L.polyline(coordinates, {
        color: '#6c757d',
        weight: 1,
        opacity: 0.3,
        dashArray: '5, 10'
    });

    const popupContent = `
        <div class="map-popup">
            <p class="mb-1"><strong>Connection:</strong> ${conn.from.name} → ${conn.to.name}</p>
            <p class="mb-1"><strong>Estimated Latency:</strong> ${conn.estimated_latency_ms}ms</p>
        </div>
    `;

    line.bindPopup(popupContent);
    line.addTo(map);
    connectionLines.push(line);
}

// Haversine formula to calculate distance between two coordinates
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function clearMap() {
    markers.forEach(marker => map.removeLayer(marker));
    connectionLines.forEach(line => map.removeLayer(line));
    userConnectionLines.forEach(line => map.removeLayer(line));
    markers = [];
    connectionLines = [];
    userConnectionLines = [];
}

function filterMapMarkers() {
    markers.forEach(marker => {
        const shouldShow = currentFilter === 'all' || 
                          marker.dbData.cloud_provider.toLowerCase().includes(currentFilter);
        
        if (shouldShow) {
            marker.addTo(map);
        } else {
            map.removeLayer(marker);
        }
    });
    
    // Also filter connection lines
    connectionLines.forEach(line => map.removeLayer(line));
    if (currentFilter === 'all') {
        connectionLines.forEach(line => line.addTo(map));
    }
}

function getLatencyClass(latencyMs) {
    if (latencyMs < 100) return 'good';
    if (latencyMs < 200) return 'medium';
    return 'bad';
}

function refreshMap() {
    const btn = document.getElementById('refresh-map-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Loading...';
    
    loadMapData().finally(() => {
        btn.disabled = false;
        btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
            Refresh Map
        `;
    });
}
</script>

<style>
.cloud-legend {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 4px;
}

.map-popup {
    min-width: 200px;
}

.latency-good { color: #28a745; }
.latency-medium { color: #ffc107; }
.latency-bad { color: #dc3545; }

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.7;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>