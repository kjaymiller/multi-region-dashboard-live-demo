{% extends "base.html" %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1>Database Performance Dashboard</h1>
        <p class="lead mb-0">Test PostgreSQL connectivity and performance</p>
    </div>
</div>

<div class="container">


    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="mb-1">Quick Actions</h5>
                            <small class="text-muted">Test all database functions</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary"
                                    hx-post="/api/database/test-all"
                                    hx-target="#all-database-result"
                                    hx-indicator="#all-database-spinner">
                                <span class="htmx-indicator spinner-border spinner-border-sm me-2" id="all-database-spinner"></span>
                                Test All Functions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Database Result -->
    <div id="all-database-result" class="mb-4"></div>

    <!-- Database Connections Management -->
    <div id="database-connections-container"
         hx-get="/api/db/connections"
         hx-trigger="load, connection-created from:body, connection-error from:body"
         hx-swap="innerHTML"></div>

    <!-- Geographic Map View -->
    {% include "partials/map_view.html" %}

    <!-- Auto-refresh Summary -->
    <div class="row mb-4" x-data="{ 
        isLoading: true, 
        lastUpdate: null,
        countdown: {{ refresh_interval }} 
    }" 
         x-init="setInterval(() => { countdown = countdown > 0 ? countdown - 1 : {{ refresh_interval }} }, 1000)">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span>Live Status</span>
                    <small class="text-muted" x-show="!isLoading">
                        Last updated: <span x-text="new Date(lastUpdate).toLocaleTimeString()"></span> â€¢ 
                        Refresh in <span x-text="countdown"></span>s
                    </small>
                    <small class="text-muted" x-show="isLoading">
                        Auto-refreshes every {{ refresh_interval }} seconds
                    </small>
                </div>
                <div class="card-body"
                     hx-get="/api/database/summary"
                     hx-trigger="load, every {{ refresh_interval }}s"
                     hx-swap="innerHTML"
                     hx-on::before-request="isLoading = true"
                     hx-on::after-request="isLoading = false; lastUpdate = new Date()">
                    <div class="text-center text-muted" x-show="isLoading">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Loading database status...
                    </div>
                    <div x-show="!isLoading" x-transition>
                        <!-- Content will be loaded here by HTMX -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Testing Card -->
    <h4 class="mb-3">Database Testing</h4>
    <div class="row">
        <div class="col-lg-6 mx-auto">
            <div class="card database-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">{{ database.name }}</h5>
                    <small class="opacity-75">Performance Tests</small>
                </div>
                <div class="card-body">
                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-primary btn-sm"
                                id="test-connection-btn"
                                hx-post="/api/database/test"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            <span class="htmx-indicator spinner-border spinner-border-sm me-1" id="database-spinner"></span>
                            Test Connection
                        </button>

                        <button class="btn btn-outline-primary btn-sm"
                                id="test-latency-btn"
                                hx-post="/api/database/latency?iterations=5"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            Measure Latency
                        </button>

                        <button class="btn btn-outline-secondary btn-sm"
                                id="test-health-btn"
                                hx-post="/api/database/health"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            Health Check
                        </button>

                        <button class="btn btn-outline-warning btn-sm"
                                id="test-load-btn"
                                hx-post="/api/database/load-test?concurrent=10"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            Load Test (10)
                        </button>
                    </div>

                    <!-- Result Container -->
                    <div class="result-container" id="database-result">
                        <div class="text-center text-muted">
                            <small>Click a button to test the database</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- AI Chat Assistant -->
    <div class="row mt-4" x-data="chat()">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chat-dots-fill me-2" viewBox="0 0 16 16">
                                <path d="M16 8c0 3.866-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7M5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0m4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                            </svg>
                            AI Performance Assistant
                        </h5>
                        <small class="text-muted">Powered by Ollama (llama3.2) - Ask questions about your database performance</small>
                    </div>
                </div>
                <div class="card-body">
                    <div x-ref="chatMessages" 
                         style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <template x-for="msg in messages" :key="messages.indexOf(msg)">
                            <div class="mb-3" 
                                 x-show="msg.text"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform translate-y-2"
                                 x-transition:enter-end="opacity-100 transform translate-y-0">
                                <div class="d-flex" :class="msg.type === 'user' ? 'justify-content-end' : ''">
                                    <div class="rounded px-3 py-2" 
                                         :class="msg.type === 'user' ? 'bg-primary text-white' : 'bg-light'" 
                                         style="max-width: 80%; white-space: pre-line;">
                                        <div x-text="msg.text"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="isLoading" class="text-center text-muted py-2">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Thinking...
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text"
                               x-model="message"
                               @keydown.enter="if(message.trim() && !isLoading) { sendMessage() }"
                               :disabled="isLoading"
                               class="form-control"
                               placeholder="Ask me about your database performance...">
                        <button class="btn btn-primary" 
                                @click="if(message.trim() && !isLoading) { sendMessage() }"
                                :disabled="isLoading || !message.trim()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                                <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Check History -->
    <div class="row mt-4" x-data="{ 
        currentView: 'table',
        refreshChart() {
            // Find the chart component and refresh it
            const chartElement = document.querySelector('#check-history-chart');
            if (chartElement && chartElement.__x) {
                chartElement.__x.$data.refresh();
            }
        }
    }">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Recent Check History</h5>
                        <small class="text-muted">Last 20 checks across all regions</small>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- View Toggle -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    :class="currentView === 'table' ? 'active' : ''"
                                    @click="currentView = 'table'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                                    <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z"/>
                                </svg>
                                Table
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    :class="currentView === 'chart' ? 'active' : ''"
                                    @click="currentView = 'chart'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-graph-up" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M0 0h1v15h15v1H0zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07"/>
                                </svg>
                                Chart
                            </button>
                        </div>
                        <!-- Refresh Button -->
                        <button class="btn btn-sm btn-outline-secondary"
                                @click="currentView === 'table' ? htmx.trigger('#check-history-table', 'check-updated') : refreshChart()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Table View -->
                    <div x-show="currentView === 'table'"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 transform -translate-y-4"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform -translate-y-4"
                         id="check-history-table"
                         hx-get="/api/checks/history?limit=20"
                         hx-trigger="load, check-updated from:body"
                         hx-swap="innerHTML">
                        <div class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Loading check history...
                        </div>
                    </div>
                    <!-- Chart View -->
                    <div x-show="currentView === 'chart'" 
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 transform -translate-y-4"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform -translate-y-4"
                         id="check-history-chart"
                         x-data="chartManager()">
                        
                        <!-- Chart Type Selector -->
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        :class="selectedChart === 'connection' ? 'active' : ''"
                                        @click="switchChart('connection')">
                                    Connection
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        :class="selectedChart === 'latency' ? 'active' : ''"
                                        @click="switchChart('latency')">
                                    Latency
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        :class="selectedChart === 'load_test' ? 'active' : ''"
                                        @click="switchChart('load_test')">
                                    Load Test
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        :class="selectedChart === 'health' ? 'active' : ''"
                                        @click="switchChart('health')">
                                    Health
                                </button>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div x-show="isLoading" class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Loading chart data...
                        </div>
                        
                        <!-- Error State -->
                        <div x-show="error" class="alert alert-warning" x-text="error"></div>
                        
                        <!-- Chart Container -->
                        <div x-show="!isLoading && !error" class="chart-container" style="position: relative; height: 400px;">
                            <canvas :id="chartId"></canvas>
                        </div>
                        
                        <!-- No Data State -->
                        <div x-show="!isLoading && !error && !hasData" class="text-center text-muted py-4">
                            <small>No data available for this chart type</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="mt-5 py-4 bg-light">
    <div class="container text-center text-muted">
        <small>Multi-Region PostgreSQL Testing Dashboard | Built with FastAPI + HTMX + Aiven</small>
    </div>
</footer>
{% endblock %}

{% block scripts %}

<!-- Fallback for HTMX buttons -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX not loaded!');
        return;
    }
    
    // Add fallback click handlers for buttons
    const buttons = [
        { id: 'test-connection-btn', url: '/api/database/test' },
        { id: 'test-latency-btn', url: '/api/database/latency?iterations=5' },
        { id: 'test-health-btn', url: '/api/database/health' },
        { id: 'test-load-btn', url: '/api/database/load-test?concurrent=10' }
    ];
    
    buttons.forEach(({ id, url }) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Fallback: Button clicked:', id);
                
                // Show loading
                const spinner = document.getElementById('database-spinner');
                if (spinner) spinner.style.display = 'inline-block';
                
                // Make request
                fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'} })
                    .then(response => response.text())
                    .then(html => {
                        const target = document.getElementById('database-result');
                        if (target) target.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Fallback request failed:', error);
                        const target = document.getElementById('database-result');
                        if (target) target.innerHTML = '<div class="alert alert-danger">Request failed: ' + error.message + '</div>';
                    })
                    .finally(() => {
                        if (spinner) spinner.style.display = 'none';
                    });
            });
        }
    });
});
</script>

<!-- Alpine.js Components -->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('chat', () => ({
            message: '',
            isLoading: false,
            messages: [
                { type: 'assistant', text: 'ðŸ‘‹ Hi! I\'m your AI assistant. Ask me about:\nâ€¢ Database latency and performance\nâ€¢ Regional comparisons\nâ€¢ Performance optimization tips\nâ€¢ Understanding your metrics' }
            ],
            
            async sendMessage() {
                if (!this.message.trim() || this.isLoading) return;
                
                const userMessage = this.message.trim();
                this.message = '';
                this.isLoading = true;
                
                // Add user message
                this.messages.push({ type: 'user', text: userMessage });
                
                // Scroll to bottom
                this.$nextTick(() => {
                    const chatContainer = this.$refs.chatMessages;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: userMessage })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.messages.push({ 
                            type: 'assistant', 
                            text: data.response 
                        });
                    } else {
                        this.messages.push({ 
                            type: 'assistant', 
                            text: 'Sorry, I encountered an error processing your request.' 
                        });
                    }
                } catch (error) {
                    this.messages.push({ 
                        type: 'assistant', 
                        text: 'Sorry, I\'m having trouble connecting right now. Please try again later.' 
                    });
                } finally {
                    this.isLoading = false;
                    
                    // Scroll to bottom again after response
                    this.$nextTick(() => {
                        const chatContainer = this.$refs.chatMessages;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                }
            }
        }));
        
        Alpine.data('chartManager', () => ({
            selectedChart: 'connection',
            isLoading: true,
            error: null,
            hasData: false,
            chartId: 'chart-' + Math.random().toString(36).substr(2, 9),
            chart: null,
            chartData: null,
            
            async init() {
                await this.loadChartData();
                
                // Watch for chart type changes
                this.$watch('selectedChart', () => {
                    this.updateChart();
                });
            },
            
            async loadChartData() {
                this.isLoading = true;
                this.error = null;
                
                try {
                    const response = await fetch('/api/checks/chart-data');
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.chartData = data;
                        this.$nextTick(() => {
                            this.updateChart();
                        });
                    } else {
                        this.error = 'Failed to load chart data';
                    }
                } catch (error) {
                    this.error = 'Error loading chart data: ' + error.message;
                } finally {
                    this.isLoading = false;
                }
            },
            
            switchChart(type) {
                this.selectedChart = type;
            },
            
            updateChart() {
                if (!this.chartData) return;
                
                // Destroy existing chart
                if (this.chart) {
                    this.chart.destroy();
                }
                
                const ctx = document.getElementById(this.chartId);
                if (!ctx) return;
                
                const chartTypeData = this.chartData[this.selectedChart];
                this.hasData = chartTypeData && chartTypeData.datasets && chartTypeData.datasets.length > 0;
                
                if (!this.hasData) return;
                
                // Chart configuration
                const config = {
                    type: 'line',
                    data: {
                        datasets: chartTypeData.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: this.getChartTitle(),
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    displayFormats: {
                                        hour: 'MMM dd HH:mm'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: this.getYAxisLabel()
                                },
                                beginAtZero: this.selectedChart !== 'latency'
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                };
                
                this.chart = new Chart(ctx, config);
            },
            
            getChartTitle() {
                const titles = {
                    'connection': 'Connection Tests (Success Rate %)',
                    'latency': 'Latency Measurements (ms)',
                    'load_test': 'Load Test Performance (Queries/sec)',
                    'health': 'Health Check Metrics'
                };
                return titles[this.selectedChart] || 'Database Metrics';
            },
            
            getYAxisLabel() {
                const labels = {
                    'connection': 'Success Rate (%)',
                    'latency': 'Latency (ms)',
                    'load_test': 'Queries per Second',
                    'health': 'Health Score'
                };
                return labels[this.selectedChart] || 'Value';
            },
            
            // Refresh chart data
            async refresh() {
                await this.loadChartData();
            }
        }));
    });
</script>
{% endblock %}
