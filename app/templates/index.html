{% extends "base.html" %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1>Database Connections Dashboard</h1>
        <p class="lead mb-0">Manage PostgreSQL database connections</p>
    </div>
</div>

<div class="container">




    <!-- Database Connections Management -->
    <div id="database-connections-container"
         hx-get="/api/db/connections"
         hx-trigger="load, connection-created from:body, connection-error from:body"
         hx-swap="innerHTML"></div>

    <!-- Geographic Map View -->
    {% include "partials/map_view.html" %}







    <!-- AI Chat Assistant -->
    <div class="row mt-4" x-data="chat()">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chat-dots-fill me-2" viewBox="0 0 16 16">
                                <path d="M16 8c0 3.866-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7M5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0m4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                            </svg>
                            AI Performance Assistant
                        </h5>
                        <small class="text-muted">Powered by Ollama (llama3.2) - Ask questions about your database performance</small>
                    </div>
                </div>
                <div class="card-body">
                    <div x-ref="chatMessages" 
                         style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <template x-for="msg in messages" :key="messages.indexOf(msg)">
                            <div class="mb-3" 
                                 x-show="msg.text"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform translate-y-2"
                                 x-transition:enter-end="opacity-100 transform translate-y-0">
                                <div class="d-flex" :class="msg.type === 'user' ? 'justify-content-end' : ''">
                                    <div class="rounded px-3 py-2" 
                                         :class="msg.type === 'user' ? 'bg-primary text-white' : 'bg-light'" 
                                         style="max-width: 80%; white-space: pre-line;">
                                        <div x-text="msg.text"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="isLoading" class="text-center text-muted py-2">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Thinking...
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text"
                               x-model="message"
                               @keydown.enter="if(message.trim() && !isLoading) { sendMessage() }"
                               :disabled="isLoading"
                               class="form-control"
                               placeholder="Ask me about your database performance...">
                        <button class="btn btn-primary" 
                                @click="if(message.trim() && !isLoading) { sendMessage() }"
                                :disabled="isLoading || !message.trim()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                                <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<footer class="mt-5 py-4 bg-light">
    <div class="container text-center text-muted">
        <small>Multi-Region PostgreSQL Testing Dashboard | Built with FastAPI + HTMX + Aiven</small>
    </div>
</footer>
{% endblock %}

{% block scripts %}



<!-- Alpine.js Components -->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('chat', () => ({
            message: '',
            isLoading: false,
            messages: [
                { type: 'assistant', text: 'ðŸ‘‹ Hi! I\'m your AI assistant. Ask me about:\nâ€¢ Database latency and performance\nâ€¢ Regional comparisons\nâ€¢ Performance optimization tips\nâ€¢ Understanding your metrics' }
            ],
            
            async sendMessage() {
                if (!this.message.trim() || this.isLoading) return;
                
                const userMessage = this.message.trim();
                this.message = '';
                this.isLoading = true;
                
                // Add user message
                this.messages.push({ type: 'user', text: userMessage });
                
                // Scroll to bottom
                this.$nextTick(() => {
                    const chatContainer = this.$refs.chatMessages;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: userMessage })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.messages.push({ 
                            type: 'assistant', 
                            text: data.response 
                        });
                    } else {
                        this.messages.push({ 
                            type: 'assistant', 
                            text: 'Sorry, I encountered an error processing your request.' 
                        });
                    }
                } catch (error) {
                    this.messages.push({ 
                        type: 'assistant', 
                        text: 'Sorry, I\'m having trouble connecting right now. Please try again later.' 
                    });
                } finally {
                    this.isLoading = false;
                    
                    // Scroll to bottom again after response
                    this.$nextTick(() => {
                        const chatContainer = this.$refs.chatMessages;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                }
            }
        }));
        

    });
</script>
{% endblock %}
