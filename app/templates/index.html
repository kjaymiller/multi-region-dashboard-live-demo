{% extends "base.html" %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1>Database Performance Dashboard</h1>
        <p class="lead mb-0">Test PostgreSQL connectivity and performance</p>
    </div>
</div>

<div class="container">
    <!-- Database Info Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Database Information</h5>
                    <small class="opacity-75">Connection details and status</small>
                </div>
                <div class="card-body">
                    <h6>{{ database.name }}</h6>
                    <p class="text-muted mb-0">PostgreSQL Database Performance Testing</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="mb-1">Quick Actions</h5>
                            <small class="text-muted">Test all database functions</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary"
                                    hx-post="/api/database/test-all"
                                    hx-target="#all-database-result"
                                    hx-indicator="#all-database-spinner">
                                <span class="htmx-indicator spinner-border spinner-border-sm me-2" id="all-database-spinner"></span>
                                Test All Functions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Database Result -->
    <div id="all-database-result" class="mb-4"></div>

    <!-- Database Connections Management -->
    <div id="database-connections-container"
         hx-get="/api/db/connections"
         hx-trigger="load"
         hx-swap="innerHTML"></div>

    <!-- Geographic Map View -->
    {% include "partials/map_view.html" %}

    <!-- Auto-refresh Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span>Live Status</span>
                    <small class="text-muted">Auto-refreshes every {{ refresh_interval }} seconds</small>
                </div>
                <div class="card-body"
                     hx-get="/api/database/summary"
                     hx-trigger="load, every {{ refresh_interval }}s"
                     hx-swap="innerHTML">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Loading database status...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Testing Card -->
    <h4 class="mb-3">Database Testing</h4>
    <div class="row">
        <div class="col-lg-6 mx-auto">
            <div class="card database-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">{{ database.name }}</h5>
                    <small class="opacity-75">Performance Tests</small>
                </div>
                <div class="card-body">
                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-primary btn-sm"
                                hx-post="/api/database/test"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            <span class="htmx-indicator spinner-border spinner-border-sm me-1" id="database-spinner"></span>
                            Test Connection
                        </button>

                        <button class="btn btn-outline-primary btn-sm"
                                hx-post="/api/database/latency?iterations=5"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            Measure Latency
                        </button>

                        <button class="btn btn-outline-secondary btn-sm"
                                hx-post="/api/database/health"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            Health Check
                        </button>

                        <button class="btn btn-outline-warning btn-sm"
                                hx-post="/api/database/load-test?concurrent=10"
                                hx-target="#database-result"
                                hx-indicator="#database-spinner">
                            Load Test (10)
                        </button>
                    </div>

                    <!-- Result Container -->
                    <div class="result-container" id="database-result">
                        <div class="text-center text-muted">
                            <small>Click a button to test the database</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- AI Chat Assistant -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chat-dots-fill me-2" viewBox="0 0 16 16">
                                <path d="M16 8c0 3.866-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7M5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0m4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                            </svg>
                            AI Performance Assistant
                        </h5>
                        <small class="text-muted">Powered by Ollama (llama3.2) - Ask questions about your database performance</small>
                    </div>
                </div>
                <div class="card-body">
                    <div id="chat-messages" style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div class="text-muted text-center py-3">
                            <p>ðŸ‘‹ Hi! I'm your AI assistant. Ask me about:</p>
                            <ul class="list-unstyled">
                                <li>â€¢ Database latency and performance</li>
                                <li>â€¢ Regional comparisons</li>
                                <li>â€¢ Performance optimization tips</li>
                                <li>â€¢ Understanding your metrics</li>
                            </ul>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text"
                               id="chat-input"
                               class="form-control"
                               placeholder="Ask me about your database performance..."
                               onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button class="btn btn-primary" onclick="sendChatMessage()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                                <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z"/>
                            </svg>
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Check History -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Recent Check History</h5>
                        <small class="text-muted">Last 20 checks across all regions</small>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- View Toggle -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button"
                                    class="btn btn-outline-secondary active"
                                    id="view-table-btn"
                                    onclick="switchView('table')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                                    <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z"/>
                                </svg>
                                Table
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="view-chart-btn"
                                    onclick="switchView('chart')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-graph-up" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M0 0h1v15h15v1H0zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07"/>
                                </svg>
                                Chart
                            </button>
                        </div>
                        <!-- Refresh Button -->
                        <button class="btn btn-sm btn-outline-secondary"
                                id="refresh-btn"
                                onclick="refreshCurrentView()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body p-0" id="check-history-container">
                    <!-- Table View -->
                    <div id="check-history-table"
                         hx-get="/api/checks/history?limit=20"
                         hx-trigger="load, check-updated from:body"
                         hx-swap="innerHTML">
                        <div class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Loading check history...
                        </div>
                    </div>
                    <!-- Chart View (hidden by default) -->
                    <div id="check-history-chart" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="mt-5 py-4 bg-light">
    <div class="container text-center text-muted">
        <small>Multi-Region PostgreSQL Testing Dashboard | Built with FastAPI + HTMX + Aiven</small>
    </div>
</footer>
{% endblock %}

{% block scripts %}


<!-- Database Dashboard JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Database Dashboard loaded');
    });

    // Simple view switching functions
    let currentView = 'table';

    function switchView(view) {
        currentView = view;
        
        // Update button states
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // Update visibility
        document.querySelectorAll('.view-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(`${view}-view`).style.display = 'block';
    }

    // Initialize view
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial view
        switchView('table');
        
        // Listen for check updates to refresh history view
        document.body.addEventListener('check-updated', function() {
            if (currentView === 'table') {
                // Refresh history if currently in table view
                htmx.ajax('GET', '/api/checks/history?limit=20', {
                    target: '#check-history-body',
                    swap: 'innerHTML'
                });
            }
        });
    });

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
{% endblock %}
